# Course_Weight-Optimizer

## 背景与用途

东北大学部分课程采用“投权选课”机制：每位学生拥有固定权重预算（例如 105 点），可将权重分配给想选的课程；每门课有最低入场券门槛（例如每门课至少投 5 点才算有效参与），并且存在容量上限。系统在截止时统一结算：若某课程有效参与人数超过容量，则按该课程投入权重排序，录取权重最高的若干人直至满额；其余同学即使投入也无法获得席位。系统允许在截止前反复撤销与修改投权，但无法看到他人的具体投权数值，只能看到每门课当前的参与人数等全局状态。

本仓库代码的目标是：在已知（1）你自己的课程偏好与候选课程集合，（2）全局状态（年级总人数、每门课容量、每门课当前/快照参与人数）的前提下，输出一组“建议投权向量”，用于在预算与入场券约束下尽量提高你选中目标课程的成功率，并给出一组基于情景扰动的“录取概率区间”（保守/中性/激进），以便你评估风险与稳健性。

需要强调：由于系统不公开个体投权分布，本项目输出的是一种“可审计的代理模型下”的推荐策略，而非严格的真实中标概率。

## 使用方式

你需要准备两个 JSON 文件：`desired_courses.json`描述你想选哪些课以及每门课对你的相对重要性（偏好强度），`global_state.json`描述当前全局状态（年级人数、所有课程的容量与当前参与人数快照）。程序运行后会给出每门目标课的建议投权值，并将目标课标注为三类：

其一是 **SAFE（未满员）**：在程序的保守/中性/激进三种情景下，该课预测的最终参与人数均不超过容量，则对该课仅需投入入场券即可，模型内录取概率视为 1。其二是 **COMP（竞争性课程）**：预测在某些情景下会满员或超员，需要分配额外权重以提高在该课上的排名竞争力，程序会对这些课进行“水位式”分配，从而把预算更集中地放到边际收益更高的课程上。其三是 **OUT（不进入）**：预算有限或边际收益过低时，程序可能建议你不对某些课程投入（投 0），以避免入场券成本稀释关键课程的竞争力。JSON文件格式如下：

>  `desired_courses.json `

```json
{
  "grade_size": 126,
  "courses": [
    {"course_id": "COURSE_01", "capacity": 30,  "bidders": 35},
    {"course_id": "COURSE_02", "capacity": 30,  "bidders": 30},
    {"course_id": "COURSE_03", "capacity": 30,  "bidders": 19},
    {"course_id": "COURSE_04", "capacity": 30,  "bidders": 31},
    {"course_id": "COURSE_05", "capacity": 30,  "bidders": 35},
    {"course_id": "COURSE_06", "capacity": 30,  "bidders": 31},
    {"course_id": "COURSE_07", "capacity": 153, "bidders": 58},
    {"course_id": "COURSE_08", "capacity": 30,  "bidders": 58}
  ]
}

```

>  `global_state.json`

```json
{
  "preferences": [
    {"course_id": "COURSE_01", "utility": 7},
    {"course_id": "COURSE_02", "utility": 10},
    {"course_id": "COURSE_03", "utility": 8},
    {"course_id": "COURSE_06", "utility": 6},
    {"course_id": "COURSE_04", "utility": 6}
  ],
  "budget": 105,
  "min_bid": 5
}

```

输出中还会给出每门课在三种情景下的概率区间（保守/中性/激进），其含义是：当“全体同学平均会进入多少门课”等关键不确定量在不同情景下变化时，你在该课上的代理成功率如何变化。你应当优先关注：哪些课程在三个情景下都稳定高概率，哪些课程对情景非常敏感（提示需要更集中投权或减少进入门数）。

## 运行思路与模型构建

**竞价模型概述：** 本系统将选课过程建模为一个多奖品的完全信息 *all-pay* 拍卖问题：每门课程相当于一个奖品（且有多个席位即多个奖品），学生在若干课程上分配权重，相当于同时参与多个“竞赛”。在这种模型下，每门课的名额会分配给出价最高的若干学生，而所有参与者无论是否拿到席位都要“支付”自己投出的权重成本。这一点很好地反映了现实：学生将有限的点数投入课程竞争且一旦投入就不能收回（即使未成功选上该课，也损失了相应点数）。当某课程竞争激烈（报名人数超过容量）时，只有权重出价排名前列的学生能够赢得该课程席位，其余出价者即使投入了权重也无法选上该课。

**多战场分配策略（目标函数）：** 学生需要在多门心仪课程之间分配有限的预算，这类似于经典的 Colonel Blotto 博弈模型——玩家在多个战场上分配兵力以争夺局部胜利。Kovenock 和 Roberson (2015) 将此类博弈推广为一般化的 Lotto 游戏模型，研究了在预算约束下玩家跨多个战场分配资源的均衡策略。借鉴这一思想，我们将每个学生视作在多个课程“战场”上同时竞价的参与者：每位学生有固定总预算，可以自由选择如何把权重点数分配给不同课程，以最大化自己的整体收益（选课满足度）。这种多奖品竞拍和多战场资源分配模型为算法提供了博弈论基础，使其更贴近实际的竞争行为。

**约束条件：** 为了贴近NEU选课的实际规则，我们在模型中加入了“入场券”限制和预算约束。具体而言，每门课程设定最低投标权重，如果学生希望竞争该课程席位，必须至少投入这个最小权重；同时每个学生的权重预算上限固定（如105点），不可超出且不能从他人处获取额外点数（预算不可转移）。这意味着学生只能在总预算范围内分配权重，并且无法通过对所有课程都投极少权重来“占座”——因为低于最低投标的出价无效。这样的设定防止了投标过程中过于零碎和不切实际的策略，确保模拟结果符合NEU的投权规则。

**未满课的贪心处理（只投最小权重）：** 为避免效率浪费与策略偏差，我们引入了“未满员课程1概率中标”的处理策略。即当某门课程的实际竞争未达到满员（报名人数少于容量）时，我们假定任何满足最低投标要求的学生都能以概率1获得该课席位。在这种情况下，学生在该课程上只需投入最低必要权重即可确保录取，其余预算可以节省下来投入到竞争更激烈的课程中。此举可以防止学生在无人竞争的课程上浪费过多的权重点数，从而提高整体效率。另外，这也鼓励学生诚实申报自己的偏好而非过度投标：传统的课程竞价机制中，学生有时会因为担心竞争而对某些课程投入过多点数，导致投标并不能真实反映他们的偏好。通过上述策略，本系统尽可能减少不必要的权重浪费和策略性夸张，使得学生的投标更贴近其真实偏好，实现更高的满意度和效率。

**主要建模假设：** 为了简化模型并基于上述理论框架，我们作出如下假设以构建算法：

- 学生都是理性的决策者，会根据自己的偏好和竞争情况优化地分配权重，目标是最大化自身的期望效用（即获得心仪课程的总满意度期望）。
- 每个学生对各课程的偏好（价值评估）是独立且私有的。一名学生获得某课程的效用不受其他学生是否获得该课程的直接影响，且学生不会因为他人的选择而改变自己的偏好顺序*（不存在外部性影响）。在完全信息环境下，我们假定每个学生对竞争形势有合理预期并据此做出决策。
- 学生的预算（权重点数）固定且不可转移，每人在当前选课周期内只能使用这105点（不考虑是否评教导致5点不同），未用完的点数不能留到下次，也不能在学生之间交易。因此每个学生都面临一个严格的总权重约束。
- 对于未满课程来说，每个人只会投最小权重。
- 未考虑本专业学生跨选通识选修课导致的权重外流和内流等问题（毕竟本专业通识选修优先保本专业的人），考虑到人数有限，这一类计算舍弃。

> *这里的他人选择相关性是仅指微信、QQ还有校园集市等渠道私下交流一门课的“好坏”，而并不是不可见当前选课的人数导致的彻底意义上的盲选

## 模型建立与算法分析

在上述框架下，我们用 $w_{ij}$ 表示学生 $i$ 分配到课程 $j$ 的权重（投标）。对每门课程 $j$，系统设置容量 $c_j$（最多可录取人数），并要求投标达到最低入场券门槛 $b_{\min}$ 才算“有效参与”。截止时统一结算：当有效参与人数超过容量时，课程 $j$ 的席位会分配给在该课上投入权重最高的前 $c_j$ 名学生；其余学生在该课程上的投入成为机会成本。由于系统不公开每位学生在每门课的具体投入，真实的“进入前 $c_j$ 名”的概率在信息不足时不可严格辨识，因此本项目采用**单调、可微、可解释**的代理概率模型来近似刻画“投入越多越有利、越拥挤越难”的方向性规律，并在此基础上生成可执行的投权建议与稳健性区间。

### 1) 决策变量与制度约束（NEU 规则的数学化）

对目标学生（你），设目标课程集合为 $J$，在每门课上的投标为 $b_j$。制度约束可以写为：

$$
\sum_{j\in J} b_j = W,\qquad 
b_j \in \{0\}\cup [b_{\min},+\infty),
$$

其中 $W$ 是预算（例如 $W=105$,评教后），$b_{\min}$ 是入场券门槛（例如 $b_{\min}=5$）。该约束表达了两个关键事实：其一是预算必须在目标课之间分配（不考虑保留预算的情形），其二是进入某门课要么不投（$b_j=0$），要么至少投入入场券（$b_j\ge b_{\min}$）。

预算与入场券共同决定了你最多能“有效进入”的课程数上界：

$$
K_{\max}=\frac{W}{b_{\min}}.
$$

这在后续用于约束全局“人均进入课程数”的量级。

### 2) 重复强度与单课预算量级

考虑因为“年级人数不同导致权重量级差异”的现象，本质来自：全局统计的“入场人数”是按课程累计计数的，同一学生进入多门课会被重复计数，因此必须引入年级总人数 $P$ 来刻画这种重叠强度。设全体课程总数为 $N$，对每门课 $j$，记 $m_j$ 为全局快照中该课的有效参与人数（即投标 $\ge b_{\min}$ 的人数）。则全体“入场总次数”与“人均进入门数”的快照估计为：

$$
M \triangleq \sum_{j=1}^{N} m_j,\qquad 
\bar{s} \triangleq \frac{M}{P}.
$$

$M$ 是按课程累计的入场次数，$\bar{s}$ 则是“人均进入课程数”的估计量，它直接反映“重复问题”的强度：当 $\bar{s}$ 越大，说明同一批人同时出现在更多课程的竞标集合中，平均到单门课的可分配预算量级就越小。考虑制度边界，将其裁剪到合理范围：

$$
\bar{s}\leftarrow \mathrm{clip}(\bar{s},1,K_{\max}).
$$

从而得到“单门课典型预算量级”的校准系数：

$$
\mu \triangleq \frac{W}{\bar{s}}.
$$

这一步是为了解决当如果有一个年级有10/100人，所有选课数据加起来等于100（每个人全选十门 / 选且只选一门）：当 $P$ 变化导致 $\bar{s}$ 变化时，$\mu$ 会自动缩放，使算法不至于在“同样的课程入场人数情景下”下给出数量级错误的投权建议。

### 3) 终局不确定性：情景扰动与未满员课程的特殊处理

尽管系统允许截止前反复修改投权，但我们通常只拿到某个时刻的全局快照，因此需要对“截止时总入场次数会增加多少”做保守外推。本项目采用三档情景（保守/中性/激进）围绕 $\bar{s}$ 扰动：

$$
s^{(t)} = \mathrm{clip}(\lambda_t \bar{s},1,K_{\max}),
\quad \lambda_t\in\{0.8,1.0,1.2\},
\qquad
M^{*(t)} = P\cdot s^{(t)}.
$$

若当前总入场次数为 $M$，则情景 $t$ 下预测的新增入场为：

$$
\Delta^{(t)} = \max\{0,\; M^{*(t)} - M\}.
$$

在缺少迁移方向信息时，采用“按当前热度占比分摊”的最小先验（你也可在代码中替换为均分、或其他启发式）：

$$
q_j=
\begin{cases}
\dfrac{m_j}{\sum_{k=1}^N m_k}, & \sum_{k=1}^N m_k>0,
\dfrac{1}{N}, & \text{否则},
\end{cases}
\qquad
\hat{m}_j^{(t)} = \min\{P,\; m_j + \Delta^{(t)} q_j\}.
$$

由此可定义“鲁棒未满员”课程：若对某门课 $j$，在三种情景下都不超过容量，则你只需投入入场券即可，代理模型内录取概率取 1：

$$
\max_t \hat{m}_j^{(t)} \le c_j
\quad\Longrightarrow\quad
b_j=b_{\min},\;\; \Pr(\text{录取 }j)=1.
$$

这个分支对应你指出的关键事实：**当课程终局不满员时，额外投权不产生边际收益，应当把预算节省给真正拥挤的课程**。同时，由于我们取的是“最坏情景”的判定，它也在一定程度上回应了“对手也不傻、也会只投入场券导致人数上升”的担忧：只要最拥挤情景下仍不满员，策略就稳健。

### 4) 竞争性课程：从竞赛成功函数到可微概率代理

在信息完备且单一奖项的竞赛模型中，常见的 **contest success function（CSF）** 会用“相对投入占比”近似成功概率。例如，对单席位课程可写为：

$$
P_{ij} = \frac{w_{ij}}{w_{ij} + \sum_{k\neq i} w_{kj}}.
$$

它体现了两个重要性质：投入越多越有利、对手总投入越大越不利。然而在 NEU 选课中，课程往往是多席位（容量 $c_j>1$）且以“前 $c_j$ 名排名”录取，真实的中标概率是一个关于全体投标向量的“排序事件概率”。在无法观测个体投标分布时，本项目不直接用上述占比公式做真实概率，而是构造一个更贴合“门槛/拥挤度”的**可微单调代理概率**，用于优化与比较。

首先定义情景 $t$ 下的拥挤度（竞争比）：

$$
\rho_j^{(t)} \triangleq \frac{\hat{m}_j^{(t)}}{c_j}.
$$

然后将其映射为“门槛尺度”（越拥挤门槛越高）：

$$
\alpha_j^{(t)} 
\triangleq 
\mu^{(t)}\cdot \ln\Big(\max\big(\rho_j^{(t)},\,1+\delta\big)\Big),
\qquad
\mu^{(t)}=\frac{W}{s^{(t)}},
$$

其中 $\delta>0$ 是平滑项（例如 $\delta=0.05$），避免 $\rho\approx 1$ 时尺度退化为 0。最后，用指数形式的代理成功率函数刻画“投得越多越接近必胜、门槛越高越难提升”：

$$
\pi_j^{(t)}(b_j)\triangleq 1-\exp\Big(-\frac{b_j}{\alpha_j^{(t)}+\varepsilon}\Big),
\qquad \varepsilon>0.
$$

该函数在 $b_j$ 上单调递增、且可导；在 $\alpha_j$ 上体现难度：同样的投入在更拥挤的课程上提升更小。它不等价于严格 top-$c_j$ 的真实概率，但在“相对比较与资源分配”的用途上具有一致性与可解释性。

### 5) 期望效用与优化目标

有了代理成功率，就可以定义期望效用。设 $u_j$ 表示你对课程 $j$ 的效用/重要性（例如高优先级课更大），则情景 $t$ 下你的期望效用写为：

$$
\mathcal{U}^{(t)}(\mathbf{b}) = \sum_{j\in J_{\text{COMP}}} u_j\,\pi_j^{(t)}(b_j) + \sum_{j\in J_{\text{SAFE}}} u_j\cdot 1,
$$

其中 $J_{\text{SAFE}}$ 为鲁棒未满员课程集合（入场券即成功），$J_{\text{COMP}}$ 为竞争性课程集合。实现上，程序通常用“中性情景”生成可执行投标向量 $\mathbf{b}$，并用三档情景输出成功率区间以呈现稳健性：

$$
\mathbf{b}^{*} \approx \arg\max_{\mathbf{b}} \mathcal{U}^{(\text{neutral})}(\mathbf{b})
\quad \text{s.t. 预算(105)与入场券(5)约束。}
$$

### 6) 水位式分配（KKT 结构）与一维二分求解

当我们固定进入的竞争性课程集合 $S\subseteq J_{\text{COMP}}$ 后，扣除 SAFE 课程的入场券成本，竞争性课程可用预算为：

$$
W' \triangleq W - |J_{\text{SAFE}}|\,b_{\min},
\qquad 
\sum_{j\in S} b_j = W',
\qquad b_j\ge b_{\min}.
$$

在上述代理概率与线性效用结构下，KKT 条件会导出“水位”式的闭式结构：存在拉格朗日乘子 $\nu>0$ 使得

$$
b_j^{*} = b_{\min}+\max\{0,\;(\alpha_j+\varepsilon)\ln\frac{u_j}{\nu(\alpha_j+\varepsilon)}-b_{\min}}, \quad j\in S,
$$

其中 $\alpha_j$（通常取中性情景 $\alpha_j^{(\text{neutral})}$）代表门槛尺度。程序通过对 $\nu$ 做一维二分搜索，使 $\sum_{j\in S} b_j^{*}=W'$ 成立。该结构的含义是：效用更大且门槛更“划算”的课程获得更多预算；当某课程的边际收益过低时，其最优解会退化为仅投入场券甚至不进入（由外层“是否进入该课”的枚举决定）。

综上，本项目在不公开个体投权分布的现实条件下，综合机制设计与竞赛博弈的结构性结论，构造出一套可解释、可复现、可执行的投权建议方案。它强调的不是对真实中标概率的精确预测，而是对“在预算与信息受限下如何更理性地分配权重”的可审计决策支持。

## 参考文献

> [1] Budish, E., Cachon, G. P., Kessler, J. B., & Othman, A. (Course Match / 课程分配点数机制相关论文).  
> [2] Barut, Y., & Kovenock, D. (1998). *The Symmetric Multiple Prize All-Pay Auction with Complete Information*.  
> [3] Kovenock, D., & Roberson, B. (General Lotto / Colonel Blotto 泛化相关论文).  
> [4] Sönmez, T., & Ünver, M. U. (2010). *combinatorial assignment / matching 相关工作论文*.
>
> *完整引用见 `ref.bib`

最后，祝各位顺利选择心仪的课程！！




